@inject ServersService ServersService
@inject BestCrushDbContext BestCrushDbContext
@inject ApplicationUpgradesHandler ApplicationUpgradesHandler
@inject DofusDbClientsFactory DofusDbClientsFactory
@inject DofusDbUpgradesHandler DofusDbUpgradesHandler
@inject NavigationManager NavigationManager
@inject ILogger<Splash> Logger;
@page "/"
@using BestCrush.Domain
@using BestCrush.Domain.Models
@using BestCrush.Domain.Services
@using BestCrush.Domain.Services.Upgrades
@using DofusSharp.Dofocus.ApiClients.Models.Servers
@using DofusSharp.DofusDb.ApiClients
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Logging
@using CurrentVersion = CurrentVersion
@layout EmptyLayout

<div class="container h-100 d-flex flex-column align-items-stretch justify-content-center gap-4 text-center py-5">
    <div class="d-flex justify-content-center">
        <img src="img/logo-684.png" width="684" height="684" alt="Logo"/>
    </div>
    <div>
        @if (_error is not null)
        {
            <div class="lead text-danger">@_error</div>
        }
        else
        {
            <div class="lead">@_progress.Message</div>
            @if (!_progress.Done)
            {
                @if (_progress.Percent is null)
                {
                    <div class="progress" role="progressbar" aria-label="Progress" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="height: 4px">
                        <div class="progress-bar progress-bar-striped bg-warning" style="width: 100%"></div>
                    </div>
                }
                else
                {
                    int p = (int)_progress.Percent;

                    <div class="progress" role="progressbar" aria-label="Progress" aria-valuenow="@p" aria-valuemin="0" aria-valuemax="100" style="height: 4px">
                        <div class="progress-bar bg-warning" style="width: @(p)%"></div>
                    </div>
                }
            }
        }
    </div>
</div>

@code {

    ProgressMessage _progress = new("Starting...", null);
    string? _error;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            ProgressSync<ProgressMessage> progress = new(m =>
                {
                    _progress = m;
                    StateHasChanged();
                }
            );

            _progress = new ProgressMessage("Migration de la base de données...", null);
            StateHasChanged();
            await BestCrushDbContext.Database.MigrateAsync();

            _progress = new ProgressMessage("Mise à jour des données...", 0);
            StateHasChanged();
            await UpgradeAsync(progress);

            _progress = new ProgressMessage("Chargement des serveurs...", null);
            StateHasChanged();
            _ = await ServersService.GetServers();

            _progress = new ProgressMessage("Prêt.", null, true);
            StateHasChanged();

            DofocusServer? currentServer = await ServersService.GetCurrentServer();
            NavigationManager.NavigateTo(currentServer is not null ? KnownRoutes.Server(currentServer) : KnownRoutes.Servers());
        }
        catch (Exception exn)
        {
            _error = "An unexpected exception has occurred.";
            Logger.LogError(exn, "An unexpected exception has occurred.");
            Application.Current?.Quit();
        }
    }

    async Task UpgradeAsync(ProgressSync<ProgressMessage>? progress = null, CancellationToken cancellationToken = default)
    {
        await ApplicationUpgradesHandler.UpgradeAsync(CurrentVersion.Version, progress?.DeriveSubtask(0, 50), cancellationToken);

        Version version = await DofusDbClientsFactory.Version().GetVersionAsync(cancellationToken);
        await DofusDbUpgradesHandler.UpgradeAsync(version, progress?.DeriveSubtask(50, 100), cancellationToken);
    }

}